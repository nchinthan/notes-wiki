{
    "title": "paging and shared memory",
    "html": "<div class=\"ds-markdown ds-markdown--block\" style=\"--ds-md-zoom: 1.143;\"><p>Yes, when you use the <code>mmap</code> function in Unix-like systems and set the <code>MAP_SHARED</code> flag in the fourth argument (<code>flags</code>), the mapped memory region will be shareable between processes. However, for processes to share this memory, they need to map the same underlying file or shared memory object. Here's how it works and how you can share it with another process:</p><hr><h3><strong>How <code>MAP_SHARED</code> Works</strong></h3><ol start=\"1\"><li><p><strong>Shared Mapping</strong>: When you specify <code>MAP_SHARED</code>, changes made to the mapped memory region are visible to all processes that map the same file or shared memory object. These changes are also written back to the file if it is backed by a file on disk.</p></li><li><p><strong>Persistence</strong>: If the mapping is backed by a file, changes are written to the file and persist even after the processes terminate. If it's backed by anonymous memory (e.g., using <code>shm_open</code>), the changes are not persistent but are shared across processes.</p></li></ol><hr><h3><strong>Steps to Share Memory Between Processes</strong></h3><p>To share memory between processes using <code>mmap</code> and <code>MAP_SHARED</code>, follow these steps:</p><h4><strong>1. Create a Shared Memory Object</strong></h4><p>Use <code>shm_open</code> to create a shared memory object. This creates a file descriptor that can be used by multiple processes.</p><div class=\"md-code-block\"><div class=\"md-code-block-banner-wrap\"><div class=\"md-code-block-banner\"><div class=\"md-code-block-infostring\">c</div><div class=\"md-code-block-action\"><div class=\"ds-markdown-code-copy-button\">Copy</div></div></div></div><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/mman.h&gt;</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/stat.h&gt;</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fcntl.h&gt;</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h&gt;</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h&gt;</span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"/my_shared_memory\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span> SIZE <span class=\"token operator\">=</span> <span class=\"token number\">4096</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Size of the shared memory region</span>\n\n    <span class=\"token comment\">// Create a shared memory object</span>\n    <span class=\"token keyword\">int</span> shm_fd <span class=\"token operator\">=</span> <span class=\"token function\">shm_open</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> O_CREAT <span class=\"token operator\">|</span> O_RDWR<span class=\"token punctuation\">,</span> <span class=\"token number\">0666</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shm_fd <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"shm_open\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Set the size of the shared memory object</span>\n    <span class=\"token function\">ftruncate</span><span class=\"token punctuation\">(</span>shm_fd<span class=\"token punctuation\">,</span> SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Map the shared memory object into the process's address space</span>\n    <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>ptr <span class=\"token operator\">=</span> <span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> SIZE<span class=\"token punctuation\">,</span> PROT_READ <span class=\"token operator\">|</span> PROT_WRITE<span class=\"token punctuation\">,</span> MAP_SHARED<span class=\"token punctuation\">,</span> shm_fd<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ptr <span class=\"token operator\">==</span> MAP_FAILED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mmap\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Write to the shared memory</span>\n    <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>ptr<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Hello, shared memory!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Unmap and close (but keep the shared memory object alive for other processes)</span>\n    <span class=\"token function\">munmap</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">,</span> SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>shm_fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></pre></div><h4><strong>2. Access the Shared Memory in Another Process</strong></h4><p>In another process, open the same shared memory object using <code>shm_open</code> and map it using <code>mmap</code>.</p><div class=\"md-code-block\"><div class=\"md-code-block-banner-wrap\"><div class=\"md-code-block-banner\"><div class=\"md-code-block-infostring\">c</div><div class=\"md-code-block-action\"><div class=\"ds-markdown-code-copy-button\">Copy</div></div></div></div><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/mman.h&gt;</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/stat.h&gt;</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fcntl.h&gt;</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h&gt;</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h&gt;</span></span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"/my_shared_memory\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token keyword\">int</span> SIZE <span class=\"token operator\">=</span> <span class=\"token number\">4096</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Open the shared memory object</span>\n    <span class=\"token keyword\">int</span> shm_fd <span class=\"token operator\">=</span> <span class=\"token function\">shm_open</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> O_RDWR<span class=\"token punctuation\">,</span> <span class=\"token number\">0666</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shm_fd <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"shm_open\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Map the shared memory object into the process's address space</span>\n    <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>ptr <span class=\"token operator\">=</span> <span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> SIZE<span class=\"token punctuation\">,</span> PROT_READ <span class=\"token operator\">|</span> PROT_WRITE<span class=\"token punctuation\">,</span> MAP_SHARED<span class=\"token punctuation\">,</span> shm_fd<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ptr <span class=\"token operator\">==</span> MAP_FAILED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mmap\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Read from the shared memory</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Message from shared memory: %s\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Unmap and close</span>\n    <span class=\"token function\">munmap</span><span class=\"token punctuation\">(</span>ptr<span class=\"token punctuation\">,</span> SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>shm_fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Optionally, unlink the shared memory object if no longer needed</span>\n    <span class=\"token function\">shm_unlink</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></pre></div><hr><h3><strong>Key Points</strong></h3><ol start=\"1\"><li><p><strong>Shared Memory Object</strong>: Use <code>shm_open</code> to create a shared memory object that can be accessed by multiple processes.</p></li><li><p><strong>File Backing</strong>: If you want the shared memory to persist beyond the lifetime of the processes, you can use a regular file instead of <code>shm_open</code>.</p></li><li><p><strong>Synchronization</strong>: When sharing memory between processes, you may need to use synchronization mechanisms (e.g., semaphores or mutexes) to avoid race conditions.</p></li><li><p><strong>Cleanup</strong>: Use <code>shm_unlink</code> to remove the shared memory object when it is no longer needed.</p></li></ol><hr><h3><strong>Example with a File</strong></h3><p>If you want to use a file instead of <code>shm_open</code>, open the file with <code>open</code> and pass the file descriptor to <code>mmap</code>. Both processes must map the same file.</p><div class=\"md-code-block\"><div class=\"md-code-block-banner-wrap\"><div class=\"md-code-block-banner\"><div class=\"md-code-block-infostring\">c</div><div class=\"md-code-block-action\"><div class=\"ds-markdown-code-copy-button\">Copy</div></div></div></div><pre><span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"shared_file\"</span><span class=\"token punctuation\">,</span> O_RDWR <span class=\"token operator\">|</span> O_CREAT<span class=\"token punctuation\">,</span> <span class=\"token number\">0666</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">ftruncate</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>ptr <span class=\"token operator\">=</span> <span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> SIZE<span class=\"token punctuation\">,</span> PROT_READ <span class=\"token operator\">|</span> PROT_WRITE<span class=\"token punctuation\">,</span> MAP_SHARED<span class=\"token punctuation\">,</span> fd<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></div><p>This approach works similarly but uses a file on disk as the backing store.</p><hr><p>By using <code>MAP_SHARED</code> and a shared memory object or file, you can efficiently share memory between processes in Unix-like systems.</p></div>"
}